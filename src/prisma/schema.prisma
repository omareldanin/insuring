generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int                 @id @default(autoincrement())
  phone              String              @unique
  name               String
  email              String              @unique
  gender             UserGender
  avatar             String?
  fcm                String[]
  password           String
  refresh_tokens     String[]
  role               UserRole
  deleted            Boolean             @default(false)
  active             Boolean             @default(true)
  verified           Boolean             @default(false)
  deletedAt          DateTime?
  birthDate          DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  admin              Admin?
  insuranceDocuments InsuranceDocument[]
  notifications      Notification[]
  partner            Partner?
  passwordReset      PasswordReset[]
  sessions           RefreshSession[]
}

model RefreshSession {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  fcm       String
  userId    Int
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Admin {
  id   Int  @id
  user User @relation(fields: [id], references: [id], onDelete: Cascade)
}

model Partner {
  id   Int  @id
  user User @relation(fields: [id], references: [id], onDelete: Cascade)
}

model PhoneOtp {
  id        Int      @id @default(autoincrement())
  phone     String
  code      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model PasswordReset {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String
  expiresAt DateTime
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id        Int      @id @default(autoincrement())
  title     String
  content   String   @default("")
  userId    Int?
  seen      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model InsurancePlan {
  id                 Int                 @id @default(autoincrement())
  name               String
  arName             String?
  hint               String?
  arHint             String?
  description        String[]
  arDescription      String[]
  recommend          Boolean             @default(false)
  forHealthGroups    Boolean             @default(false)
  insuranceType      InsuranceTypeEnum
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  carRules           CarRules[]
  companyPlan        CompanyPlan[]
  healthRules        HealthRules[]
  insuranceDocuments InsuranceDocument[]
  lifeRules          LifeRules[]

  @@unique([name, insuranceType])
}

model InsuranceCompany {
  id                 Int                 @id @default(autoincrement())
  name               String              @unique
  arName             String?
  logo               String?
  link               String?
  email              String              @unique
  ruleType           CarRuleType         @default(RANGE)
  companyType        CompanyTypeEnum
  insuranceTypes     InsuranceTypeEnum[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  link2              String?
  carRules           CarRules[]
  companyPlans       CompanyPlan[]
  healthRules        HealthRules[]
  insuranceDocuments InsuranceDocument[]
  lifeRules          LifeRules[]
}

model CompanyPlan {
  id         Int              @id @default(autoincrement())
  companyId  Int
  planId     Int
  features   String[]         @default(["third party liability", "stantard support"])
  arFeatures String[]         @default(["third party liability", "stantard support"])
  createdAt  DateTime         @default(now())
  company    InsuranceCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan       InsurancePlan    @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([companyId, planId])
}

model CarMake {
  id             Int            @id @default(autoincrement())
  name           String         @unique
  normalizedName String         @unique
  createdAt      DateTime       @default(now())
  models         CarModel[]
  carRuleGroups  CarRuleGroup[]
}

model CarModel {
  id             Int            @id @default(autoincrement())
  name           String
  normalizedName String
  makeId         Int
  createdAt      DateTime       @default(now())
  make           CarMake        @relation(fields: [makeId], references: [id])
  carRuleGroups  CarRuleGroup[]
  years          CarYear[]

  @@unique([normalizedName, makeId])
}

model CarYear {
  id                        Int                        @id @default(autoincrement())
  year                      Int
  minimumPrice              Int?                       @default(0)
  modelId                   Int
  createdAt                 DateTime                   @default(now())
  carRuleGroups             CarRuleGroup[]
  model                     CarModel                   @relation(fields: [modelId], references: [id])
  insuranceDocumentCarInfos InsuranceDocumentCarInfo[]

  @@unique([year, modelId])
}

model HealthRules {
  id                 Int               @id @default(autoincrement())
  from               Int
  to                 Int
  gender             UserGender
  insuranceType      InsuranceTypeEnum
  price              Int
  createdAt          DateTime          @default(now())
  planId             Int?
  insuranceCompanyId Int?
  insuranceCompany   InsuranceCompany? @relation(fields: [insuranceCompanyId], references: [id], onDelete: Cascade)
  plan               InsurancePlan?    @relation(fields: [planId], references: [id], onDelete: Cascade)
  members            Member[]
}

model LifeRules {
  id                         Int                         @id @default(autoincrement())
  from                       Int
  to                         Int
  gender                     UserGender
  insuranceType              InsuranceTypeEnum
  persitage                  Float
  createdAt                  DateTime                    @default(now())
  planId                     Int?
  insuranceCompanyId         Int?
  insuranceDocumentLifeInfos InsuranceDocumentLifeInfo[]
  insuranceCompany           InsuranceCompany?           @relation(fields: [insuranceCompanyId], references: [id], onDelete: Cascade)
  plan                       InsurancePlan?              @relation(fields: [planId], references: [id], onDelete: Cascade)
}

model CarRules {
  id                        Int                        @id @default(autoincrement())
  ruleType                  CarRuleType
  from                      Int?
  to                        Int?
  persitage                 Float
  type                      CarTypeEnum                @default(new)
  insuranceType             InsuranceTypeEnum
  createdAt                 DateTime                   @default(now())
  planId                    Int?
  insuranceCompanyId        Int?
  carGroups                 CarRuleGroup[]
  insuranceCompany          InsuranceCompany?          @relation(fields: [insuranceCompanyId], references: [id], onDelete: Cascade)
  plan                      InsurancePlan?             @relation(fields: [planId], references: [id], onDelete: Cascade)
  insuranceDocumentCarRules InsuranceDocumentCarInfo[]
}

model CarRuleGroup {
  id        Int       @id @default(autoincrement())
  ruleId    Int
  groupName String
  makeId    Int
  modelId   Int?
  year      Int?
  carYearId Int?
  carYear   CarYear?  @relation(fields: [carYearId], references: [id])
  make      CarMake   @relation(fields: [makeId], references: [id])
  model     CarModel? @relation(fields: [modelId], references: [id])
  rule      CarRules  @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([groupName])
  @@index([makeId, modelId, year])
}

model InsuranceDocument {
  id             Int                          @id @default(autoincrement())
  insuranceType  InsuranceTypeEnum
  startDate      DateTime?
  endDate        DateTime?
  confirmed      Boolean                      @default(false)
  paid           Boolean                      @default(false)
  paidKey        String?
  documentNumber String?
  userId         Int
  planId         Int
  companyId      Int
  createdAt      DateTime                     @default(now())
  updatedAt      DateTime                     @updatedAt
  company        InsuranceCompany             @relation(fields: [companyId], references: [id], onDelete: NoAction)
  plan           InsurancePlan                @relation(fields: [planId], references: [id], onDelete: NoAction)
  user           User                         @relation(fields: [userId], references: [id], onDelete: NoAction)
  carInfo        InsuranceDocumentCarInfo?
  healthInfo     InsuranceDocumentHealthInfo?
  lifeInfo       InsuranceDocumentLifeInfo?

  @@index([userId, companyId])
}

model InsuranceDocumentCarInfo {
  id                  Int               @id @default(autoincrement())
  persitage           Float
  price               Int
  finalPrice          Int
  idImage             String
  carLicence          String
  driveLicence        String
  carYearId           Int?
  ruleId              Int
  insuranceDocumentId Int               @unique
  carYear             CarYear?          @relation(fields: [carYearId], references: [id])
  insuranceDocument   InsuranceDocument @relation(fields: [insuranceDocumentId], references: [id])
  rule                CarRules          @relation(fields: [ruleId], references: [id], onDelete: NoAction)
}

model InsuranceDocumentLifeInfo {
  id                  Int               @id @default(autoincrement())
  persitage           Float
  price               Int
  finalPrice          Int
  idImage             String
  ruleId              Int
  insuranceDocumentId Int               @unique
  insuranceDocument   InsuranceDocument @relation(fields: [insuranceDocumentId], references: [id])
  rule                LifeRules         @relation(fields: [ruleId], references: [id], onDelete: NoAction)
}

model InsuranceDocumentHealthInfo {
  id                        Int                     @id @default(autoincrement())
  type                      InsuranceHealthTypeEnum
  totalPrice                Int
  groupName                 String?
  companyTaxRegister        String?
  companyCommercialRegister String?
  insuranceDocumentId       Int?                    @unique
  insuranceDocument         InsuranceDocument?      @relation(fields: [insuranceDocumentId], references: [id])
  members                   Member[]
}

model Member {
  id                            Int                          @id @default(autoincrement())
  age                           Int
  gender                        UserGender
  price                         Int
  image                         String
  idImage                       String
  insuranceDocumentHealthInfoId Int?
  ruleId                        Int
  insuranceDocumentHealthInfo   InsuranceDocumentHealthInfo? @relation(fields: [insuranceDocumentHealthInfoId], references: [id])
  rule                          HealthRules                  @relation(fields: [ruleId], references: [id], onDelete: NoAction)
}

enum UserRole {
  ADMIN
  CLIENT
  PARTNER
}

enum UserGender {
  male
  female
}

enum InsuranceTypeEnum {
  CAR
  HEALTH
  LIFE
}

enum InsuranceHealthTypeEnum {
  INDIVIDUAL
  FAMILY
  GROUP
}

enum CarTypeEnum {
  used
  new
}

enum CompanyTypeEnum {
  SOLIDARITY
  COMMERCIAL
}

enum CarRuleType {
  RANGE
  GROUP
}
